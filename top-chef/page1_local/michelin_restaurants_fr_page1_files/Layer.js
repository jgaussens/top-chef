JSEPackage("ViaMichelin.Api.MMap.Module.ClusteredPois.Layer"),JSEImportApi("ViaMichelin.Api.MMap.Core.Layer"),JSEImportApi("ViaMichelin.Api.MMap.Core.Layer.Vector.Renderer"),JSEImportApi("ViaMichelin.Api.Util.Object"),JSEImportApi("ViaMichelin.Api.Util.Drawing"),JSEImportApi("ViaMichelin.Api.Util.Animation"),JSEImportApi("ViaMichelin.Api.MMap.Module.ClusteredPois.Layer.LayerTitle"),ViaMichelin.Api.MMap.Module.ClusteredPois.Layer=function(i){ViaMichelin.Api.Util.Object.extend(this,ViaMichelin.Api.MMap.Core.Layer.Vector.Renderer),ViaMichelin.Api.Util.Object.extend(this,ViaMichelin.Api.MMap.Module.ClusteredPois.Layer.LayerTitle),this.keyList={},this.style=i},ViaMichelin.Api.MMap.Module.ClusteredPois.Layer.prototype={keyList:null,options:{pane:"overlayPane"},clean:function(){this.drawing&&this.drawing.clear()},draw:function(){if($isNotEmpty(this.keyList)){var i=1,t=this._map.getZoom();this.zoomFactor&&(i=Math.pow(2,t-this.zoomFactor)),0===parseInt(this.drawing._canvas.style.opacity)&&(this._plugDrawingEvent(),this.drawing._canvas.style.opacity=1,this._startAnim=!1);for(var e in this.keyList)if(this.keyList.hasOwnProperty(e)&&this.keyList[e].list&&this.keyList[e].list.length>0)for(var n=0;n<this.keyList[e].list.length;n++){var a=null,s=this.style[e].style,o=this._map.latLonToContainerPoint(this.keyList[e].list[n].coords),r=3;""===this.keyList[e].list[n].id?(r=5+parseInt(3*Math.log(parseInt(this.keyList[e].list[n].desc,10)),10),r=Math.floor(r*i),a="function"==typeof s.grouping?s.grouping(this.keyList[e].list[n]):s.grouping):(a="function"==typeof s.unitary?s.unitary(this.keyList[e].list[n]):s.unitary,$isNotEmpty(a.width)&&(r=parseInt(a.width,10))),this.drawing.drawCircle([o.x,o.y],r,a,this.keyList[e].list[n])}this.stimulate("draw")}},setData:function(i,t){this.zoomFactor=t||1;for(var e in i)i.hasOwnProperty(e)&&(this.keyList[e]=i[e]);this._update()},release:function(i){var t,e=0;for(t in i)i.hasOwnProperty(t)&&delete this.keyList[t];for(t in this.keyList)e++;0===e?(this._unplugDrawingEvent(),this._map&&(this._map._clusteredPoiLayer=null,this._map.unplugWire("resize",this._onMapResize,this),this._map.removeLayer(this))):this._update()},toString:function(){return"[ViaMichelin.Api.MMap.Module.ClusteredPois.Layer]"},_area_onmousedown:function(){return this._mapPosition=this._map.getCenter(),!1},_area_onmouseover:function(i,t){i=window.event||i;var e=this._map.mouseEventToContainerPoint(i);return t&&(this.stimulate("PoiOverEvent",{coords:e,latlon:this._map.containerPointToLatLon(e),poi:t}),ViaMichelin.Api.Util.Dom.addClass(this._container,"mmap-interactive")),!1},_area_onmouseout:function(i,t){if(t){i=window.event||i;var e=this._map.mouseEventToContainerPoint(i);this.stimulate("PoiOutEvent",{coords:e,latlon:this._map.containerPointToLatLon(e),poi:t}),ViaMichelin.Api.Util.Dom.removeClass(this._container,"mmap-interactive")}return!1},_area_onmousemove:function(i,t){i=window.event||i;var e=this._map.mouseEventToContainerPoint(i);return this.stimulate("PoiMoveEvent",{coords:e,latlon:this._map.containerPointToLatLon(e),poi:t}),!1},_area_onmouseup:function(i,t){if(i=window.event||i,this._mapPosition&&this._mapPosition.equals(this._map.getCenter())){var e=t;ToJSEObject(e);var n=this._map.mouseEventToContainerPoint(i);this.stimulate("PoiClickEvent",{coords:n,latlon:this._map.containerPointToLatLon(n),poi:e})}return!1},_animateZoom:function(i){this._startAnim=!0,ViaMichelin.Api.MMap.Core.Layer.Vector.Renderer.prototype._animateZoom.call(this,i)},_initContainer:function(){var i=this._map.getSize();this._container=document.createElement("div"),this._container.className="map-clustered-pois mmap-zoom-animated",this._container.style.width=i.x+"px",this._container.style.height=i.y+"px";var t="",e=document.createElement("canvas");e.getContext?(this.render="CANVAS",t="vmapi-render-canvas"):(this.render="VML",t="vmapi-render-vml"),this.drawing=new ViaMichelin.Api.Util.Drawing(this._container,this._map.getSize().x,this._map.getSize().y,{rendering:this.render,className:t}),this._plugDrawingEvent(),this._map.plugWire("resize",this._onMapResize,this)},_onMapResize:function(){var i=this._map.getSize();this._container.style.width=i.x+"px",this._container.style.height=i.y+"px",this.drawing.resize(i)},_update:function(){ViaMichelin.Api.MMap.Core.Layer.Vector.Renderer.prototype._update.call(this);var i=this._bounds;this._startAnim?(this._cleanAnimation(),this._startAnim=!1):(this.clean(),ViaMichelin.Api.Util.Dom.setPosition(this._container,i.min),this.draw())},_cleanAnimation:function(){var i=new ViaMichelin.Api.Util.Animation,t=this.drawing._canvas,e=this;t&&(t.style.opacity=1,e._unplugDrawingEvent(),i.transition(t,[{property:"opacity",duration:.25,timingFunction:"ease",value:0}],function(){}))},_plugDrawingEvent:function(){this.isPlugged||(this.drawing.plugWire("ShapeEvent_mousedown",this._area_onmousedown,this),this.drawing.plugWire("ShapeEvent_mouseover",this._area_onmouseover,this),this.drawing.plugWire("ShapeEvent_mouseout",this._area_onmouseout,this),this.drawing.plugWire("ShapeEvent_mouseup",this._area_onmouseup,this),this.drawing.plugWire("ShapeEvent_mousemove",this._area_onmousemove,this),this.isPlugged=!0)},_unplugDrawingEvent:function(){this.drawing&&(this.drawing.unplugWire("ShapeEvent_mousedown",this._area_onmousedown,this),this.drawing.unplugWire("ShapeEvent_mouseover",this._area_onmouseover,this),this.drawing.unplugWire("ShapeEvent_mouseout",this._area_onmouseout,this),this.drawing.unplugWire("ShapeEvent_mouseup",this._area_onmouseup,this),this.drawing.unplugWire("ShapeEvent_mousemove",this._area_onmousemove,this),this.isPlugged=!1)}};